# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## First Steps

**Your first tool call in this repository MUST be reading .claude/CODING_STANDARD.md.
Do not read any other files, search, or take any actions until you have read it.**
This contains InfraHouse's comprehensive coding standards for Terraform, Python, and general formatting rules.

## Module Overview

This is `terraform-aws-key`, an InfraHouse Terraform module that creates an AWS KMS key with an alias and configurable key policy. It supports optional `key_users` for granting encrypt/decrypt permissions to specified IAM roles. Published to the Terraform Registry as `infrahouse/key/aws`.

## Commands

```bash
make bootstrap          # Install Python dependencies (pip + requirements.txt)
make format             # Format all files (terraform fmt + black tests)
make lint               # Check Terraform formatting (terraform fmt --check)
make test               # Run full test suite (requires AWS credentials)
make test-keep          # Run tests, keep AWS resources after (for debugging)
make test-clean         # Run tests, destroy AWS resources after
make install-hooks      # Symlink git hooks from hooks/ to .git/hooks/
```

Run a single test:
```bash
pytest -xvvs --test-role-arn "arn:aws:iam::303467602807:role/key-tester" tests/test_module.py::test_module
```

## Architecture

- **Root module** (`main.tf`, `variables.tf`, `outputs.tf`, `data-sources.tf`, `locals.tf`): Creates `aws_kms_key` and `aws_kms_alias`. Key policy grants root account full KMS access, with optional dynamic statement for `key_users`.
- **Test fixtures** (`test_data/`): Contains two Terraform configurations used by pytest:
  - `test_data/probe_role/` - Creates an IAM role used to test key access
  - `test_data/key/` - Instantiates the root module with the probe role as a key user
- **Tests** (`tests/`): Python pytest tests using `pytest-infrahouse` fixtures. Tests create real AWS infrastructure via `terraform_apply` context manager, then verify encrypt/decrypt works using AWS Encryption SDK with the created KMS key.

## Versioning

Version is tracked in two places, kept in sync by `bumpversion` (configured in `.bumpversion.cfg`):
- `locals.tf` (`module_version`)
- `README.md` (usage example)

Changelog is generated by `git-cliff` (configured in `cliff.toml`).

## Conventions

- **Commits**: Conventional Commits enforced by `hooks/commit-msg` hook (types: feat, fix, docs, refactor, perf, test, build, ci, chore, revert, security, style)
- **Pre-commit hook**: Runs `terraform fmt -check -recursive` and `terraform-docs` to auto-update README.md
- **README.md**: Auto-generated between `<!-- BEGIN_TF_DOCS -->` markers by terraform-docs; do not edit that section manually
- **Managed files**: Files marked "managed by Terraform in github-control repository" should not be edited in this repo
- **Max line length**: 120 characters for all files